<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voltage & Current Meter (Supabase Connected)</title>
  <style>
    :root {
      --bg: #0f1724;
      --panel: #0b1220;
      --accent: #60a5fa;
      --text: #e6eef8;
    }

    body {
      font-family: Inter, system-ui, Segoe UI, Helvetica, Arial;
      background: linear-gradient(180deg, #071025 0%, #081827 60%);
      color: var(--text);
      margin: 0;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .panel {
      background: linear-gradient(180deg, var(--panel), #071020);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      width: 100%;
      max-width: 1100px;
      height: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }

    img.logo {
      max-width: 240px;
      height: auto;
      display: block;
      margin: 0 auto 8px;
      border-radius: 10px;
    }

    .top-title {
      text-align: center;
    }

    .meters-graphs {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      gap: 40px;
      width: 100%;
    }

    .meter-graph-pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: 25px;
      flex: 1 1 400px;
      min-width: 320px;
      padding: 10px 0;
      position: relative;
    }

    .gauge {
      width: 100%;
      max-width: 380px;
      height: auto;
      aspect-ratio: 420 / 220;
      margin-bottom: 5px;
    }

    .chart-container {
      width: 100%;
      max-width: 380px;
      height: 220px;
      background: #0a1325;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
    }

    .gauge svg {
      width: 100%;
      height: 100%;
      overflow: visible;
    }

    .ticks {
      stroke: #6b7280;
      stroke-width: 2;
    }

    .tick-label {
      fill: #9fb4d8;
      font-size: 12px;
    }

    .needle {
      stroke: var(--accent);
      stroke-width: 3;
      stroke-linecap: round;
    }

    .hub {
      fill: var(--accent);
    }

    .value-readout {
      font-weight: 700;
      font-size: 20px;
      text-align: center;
      margin-top: 6px;
    }

    .meter-title {
      font-weight: 700;
      font-size: 16px;
      color: #cfe6ff;
      text-align: center;
    }

    footer {
      font-size: 12px;
      color: #8ea9ce;
      text-align: center;
      margin-top: 12px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #60a5fa;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }

    /* ==============================
       üîπ Responsive (Mobile)
       ============================== */
    @media (max-width: 768px) {
      .meters-graphs {
        flex-direction: column;
        gap: 25px;
      }

      .meter-graph-pair {
        width: 100%;
      }

      .gauge {
        max-width: 320px;
      }

      .chart-container {
        display: none; /* ‚ùå Hide charts on mobile */
      }

      img.logo {
        max-width: 180px;
      }

      .value-readout {
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="panel">
    <img src="https://www.cckhrm.com.my/wp-content/uploads/2022/06/cropped-Logo.jpg" alt="Logo" class="logo" />
    <div class="top-title">
      <div class="meter-title">Voltage & Current Meter</div>
    </div>

    <div class="meters-graphs">
      <!-- Voltage -->
      <div class="meter-graph-pair">
        <div class="gauge" id="voltageGauge">
          <svg viewBox="0 0 420 220">
            <path d="M80 270 A150 140 0 1 1 340 270" fill="none" stroke="#07182a" stroke-width="75"
              stroke-linecap="round" />
            <g id="voltageTicks" transform="translate(210,200) rotate(-90)"></g>
            <g id="vNeedleGroup" transform="translate(210,200)">
              <line id="vNeedle" x1="0" y1="0" x2="0" y2="-120" class="needle" />
              <circle cx="0" cy="0" r="8" class="hub" />
            </g>
          </svg>
        </div>
        <div class="value-readout" id="vValue">0 V</div>
        <div class="chart-container">
          <canvas id="voltageChart"></canvas>
        </div>
      </div>

      <!-- Current -->
      <div class="meter-graph-pair">
        <div class="gauge" id="currentGauge">
          <svg viewBox="0 0 420 220">
            <path d="M80 270 A150 140 0 1 1 340 270" fill="none" stroke="#07182a" stroke-width="75"
              stroke-linecap="round" />
            <g id="currentTicks" transform="translate(210,200) rotate(-90)"></g>
            <g id="iNeedleGroup" transform="translate(210,200)">
              <line id="iNeedle" x1="0" y1="0" x2="0" y2="-120" class="needle" />
              <circle cx="0" cy="0" r="8" class="hub" />
            </g>
          </svg>
        </div>
        <div class="value-readout" id="iValue">0 A</div>
        <div class="chart-container">
          <canvas id="currentChart"></canvas>
        </div>
      </div>
    </div>

    <div style="margin-top:20px;">
      <button id="toggleBtn">Loading...</button>
    </div>
  </div>

  <footer>Voltage & Current Meter ‚Äî Supabase Live Data</footer>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const SUPABASE_URL = "https://qliblvtrlkrznsrhqgne.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0h-kh1qqKC2VJNht-XvTag_htW3z9o9";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let vMin = 0, vMax = 300, iMin = 0, iMax = 10;
    let smoothing = 500;

    function valueToAngle(value, min, max) {
      const ratio = (value - min) / (max - min);
      return -120 + ratio * 240;
    }

    function renderTicks(group, min, max, step) {
      group.innerHTML = '';
      const total = Math.round((max - min) / step);
      for (let i = 0; i <= total; i++) {
        const val = min + i * step;
        const ratio = (max - val) / (max - min);
        const angleDeg = -120 + ratio * 240;
        const angle = (Math.PI / 180) * angleDeg;
        const rOuter = 170;
        const rInner = (i % 5 === 0 ? 120 : 140);
        const x1 = Math.cos(angle) * rInner;
        const y1 = Math.sin(angle) * -rInner;
        const x2 = Math.cos(angle) * rOuter;
        const y2 = Math.sin(angle) * -rOuter;

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('class', 'ticks');
        line.setAttribute('stroke-width', i % 5 === 0 ? 3 : 1.6);
        group.appendChild(line);

        if (i % 5 === 0) {
          const tx = Math.cos(angle) * 100;
          const ty = Math.sin(angle) * -100 + 6;
          const tGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          tGroup.setAttribute('transform', `rotate(${90}, ${tx + 2}, ${ty - 4})`);
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          text.setAttribute('x', tx);
          text.setAttribute('y', ty);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('dominant-baseline', 'middle');
          text.setAttribute('class', 'tick-label');
          text.textContent = val;
          tGroup.appendChild(text);
          group.appendChild(tGroup);
        }
      }
    }

    const vTicks = document.getElementById('voltageTicks');
    const iTicks = document.getElementById('currentTicks');
    renderTicks(vTicks, 0, 300, 10);
    renderTicks(iTicks, 0, 10, 1);

    const vValue = document.getElementById('vValue');
    const iValue = document.getElementById('iValue');
    const vNeedleGroup = document.getElementById('vNeedleGroup');
    const iNeedleGroup = document.getElementById('iNeedleGroup');

    function setNeedle(needleGroup, value, min, max) {
      const angle = valueToAngle(value, min, max);
      needleGroup.style.transition = `transform ${smoothing}ms cubic-bezier(.2,.9,.3,1)`;
      needleGroup.style.transform = `translate(210px,200px) rotate(${angle}deg)`;
    }

    function updateDisplays(voltage, current) {
      vValue.textContent = Number(voltage).toFixed(1) + ' V';
      iValue.textContent = Number(current).toFixed(2) + ' A';
      setNeedle(vNeedleGroup, voltage, vMin, vMax);
      setNeedle(iNeedleGroup, current, iMin, iMax);
      addData(voltage, current);
    }

    const vCtx = document.getElementById('voltageChart');
    const iCtx = document.getElementById('currentChart');

    const vChart = new Chart(vCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ data: [], borderColor: '#60a5fa', borderWidth: 2, tension: 0.3 }] },
      options: { scales: { x: { display: false }, y: { min: 0, max: 300 } }, plugins: { legend: { display: false } } }
    });

    const iChart = new Chart(iCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ data: [], borderColor: '#34d399', borderWidth: 2, tension: 0.3 }] },
      options: { scales: { x: { display: false }, y: { min: 0, max: 10 } }, plugins: { legend: { display: false } } }
    });

    function addData(voltage, current) {
      const time = new Date().toLocaleTimeString();
      vChart.data.labels.push(time);
      vChart.data.datasets[0].data.push(voltage);
      iChart.data.labels.push(time);
      iChart.data.datasets[0].data.push(current);

      if (vChart.data.labels.length > 20) {
        vChart.data.labels.shift();
        vChart.data.datasets[0].data.shift();
        iChart.data.labels.shift();
        iChart.data.datasets[0].data.shift();
      }

      vChart.update();
      iChart.update();
    }

    async function fetchLatestReading() {
      const { data, error } = await supabaseClient
        .from("readings")
        .select("id, voltage, current")
        .order("id", { ascending: false })
        .limit(1);
      if (!error && data && data.length > 0) {
        const { voltage, current } = data[0];
        updateDisplays(voltage, current);
      }
    }

    setInterval(fetchLatestReading, 1000);

    const toggleBtn = document.getElementById('toggleBtn');
    async function fetchButtonState() {
      const { data, error } = await supabaseClient
        .from('button_state')
        .select('id, state')
        .order('id', { ascending: false })
        .limit(1);
      if (!error && data && data.length > 0) {
        const { id, state } = data[0];
        toggleBtn.textContent = state ? 'Turn OFF' : 'Turn ON';
        toggleBtn.dataset.rowId = id;
        toggleBtn.dataset.state = state;
        toggleBtn.style.background = state ? '#ef4444' : '#60a5fa';
      }
    }

    toggleBtn.addEventListener('click', async () => {
      const newState = !(toggleBtn.dataset.state === 'true');
      const rowId = toggleBtn.dataset.rowId;
      const { error } = await supabaseClient
        .from('button_state')
        .update({ state: newState, updated_at: new Date().toISOString() })
        .eq('id', rowId);
      if (!error) fetchButtonState();
    });

    fetchLatestReading();
    fetchButtonState();
  </script>
</body>

</html>
